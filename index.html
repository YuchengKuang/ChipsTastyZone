<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width">
        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <link rel="stylesheet" href="css/leaflet.css">
        <link rel="stylesheet" href="css/L.Control.Layers.Tree.css">
        <link rel="stylesheet" href="css/qgis2web.css">
        <link rel="stylesheet" href="css/fontawesome-all.min.css">
        <link rel="stylesheet" href="css/leaflet.photon.css">
        <style>
        html, body, #map {
            width: 100%;
            height: 100%;
            padding: 0;
            margin: 0;
        }
        
        /* Weather Information Box Styles */
        #weather-box {
            position: absolute;
            bottom: 10px;
            right: 10px;
            width: 300px;
            background: rgba(255, 255, 255, 0.95);
            border: 2px solid #007cba;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            font-family: Arial, sans-serif;
            display: none;
        }
        
        #weather-box h3 {
            margin: 0 0 10px 0;
            color: #007cba;
            font-size: 18px;
            border-bottom: 1px solid #ddd;
            padding-bottom: 5px;
        }
        
        .weather-item {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            padding: 5px 0;
        }
        
        .weather-label {
            font-weight: bold;
            color: #333;
        }
        
        .weather-value {
            color: #666;
        }
        
        .weather-icon {
            width: 50px;
            height: 50px;
            float: right;
            margin-left: 10px;
        }
        
        .close-weather {
            position: absolute;
            top: 5px;
            right: 10px;
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #999;
        }
        
        .close-weather:hover {
            color: #333;
        }
        
        .weather-loading {
            text-align: center;
            color: #666;
            font-style: italic;
        }
        
        /* Weather Button Styles */
        #weather-button {
            position: absolute;
            bottom: 20px;
            right: 380px;
            background: #007cba;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 12px 16px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            font-family: Arial, sans-serif;
            transition: background-color 0.3s ease;
        }
        
        #weather-button:hover {
            background: #005a87;
        }
        
        #weather-button:active {
            transform: translateY(1px);
        }
        
        /* TL Index Calculator Styles */
        #tl-calculator {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 280px;
            background: rgba(255, 255, 255, 0.95);
            border: 2px solid #e74c3c;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            font-family: Arial, sans-serif;
        }
        
        #tl-calculator h3 {
            margin: 0 0 15px 0;
            color: #e74c3c;
            font-size: 16px;
            border-bottom: 1px solid #ddd;
            padding-bottom: 5px;
        }
        
        .tl-input-group {
            margin: 10px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .tl-input-group label {
            font-weight: bold;
            color: #333;
            font-size: 12px;
            width: 100px;
        }
        
        .tl-input-group input {
            width: 80px;
            padding: 4px 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
        }
        
        .tl-input-group span {
            font-size: 11px;
            color: #666;
            width: 40px;
            text-align: left;
        }
        
        .tl-result {
            background: #f8f9fa;
            border: 1px solid #e74c3c;
            border-radius: 4px;
            padding: 10px;
            margin: 15px 0 10px 0;
            text-align: center;
        }
        
        .tl-result-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }
        
        .tl-result-value {
            font-size: 18px;
            font-weight: bold;
            color: #e74c3c;
        }
        
        .tl-status {
            font-size: 11px;
            margin-top: 5px;
            padding: 3px 6px;
            border-radius: 3px;
            text-align: center;
        }
        
        .tl-status.low { background: #d4edda; color: #155724; }
        .tl-status.medium { background: #fff3cd; color: #856404; }
        .tl-status.high { background: #f8d7da; color: #721c24; }
        
        .calculate-btn {
            width: 100%;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
        }
        
        .calculate-btn:hover {
            background: #c0392b;
        }
        
        .auto-update {
            font-size: 10px;
            color: #666;
            text-align: center;
            margin-top: 5px;
            font-style: italic;
        }
        
        /* TL Status Legend */
        .tl-legend {
            margin-top: 10px;
            padding: 8px;
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .tl-legend-title {
            font-size: 11px;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
            text-align: center;
        }
        
        .tl-legend-item {
            display: flex;
            align-items: center;
            margin: 3px 0;
            font-size: 10px;
        }
        
        .tl-legend-color {
            width: 12px;
            height: 12px;
            border-radius: 2px;
            margin-right: 6px;
            border: 1px solid #ccc;
        }
        
        .tl-legend-color.low {
            background: #d4edda;
        }
        
        .tl-legend-color.medium {
            background: #fff3cd;
        }
        
        .tl-legend-color.high {
            background: #f8d7da;
        }
        
        .tl-legend-text {
            color: #555;
        }
        
        /* Custom popup styling for buffer store info */
        .custom-popup .leaflet-popup-content-wrapper {
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        
        .custom-popup .leaflet-popup-content {
            margin: 0;
            padding: 0;
        }
        
        .custom-popup .leaflet-popup-tip {
            background: white;
        }
        </style>
        <title></title>
    </head>
    <body>
        <div id="map">
        </div>
        
        <!-- TL Index Calculator -->
        <div id="tl-calculator">
            <h3>üçü Tasty Loss Index Calculator</h3>
            
            <div class="tl-input-group">
                <label>Humidity (H):</label>
                <input type="number" id="humidity-input" value="50" min="0" max="100" step="1">
                <span>%</span>
            </div>
            
            <div class="tl-input-group">
                <label>Temperature (T):</label>
                <input type="number" id="temperature-input" value="20" min="-40" max="60" step="0.1">
                <span>¬∞C</span>
            </div>
            
            <div class="tl-input-group">
                <label>Wind Speed (W):</label>
                <input type="number" id="wind-input" value="5" min="0" max="200" step="0.1">
                <span>km/h</span>
            </div>
            
            <div class="tl-input-group">
                <label>Distance (d):</label>
                <input type="number" id="distance-input" value="500" min="0" max="10000" step="1">
                <span>meters</span>
            </div>
            
            <button class="calculate-btn" onclick="calculateTL()">Calculate TL Index</button>
            
            <div class="tl-result">
                <div class="tl-result-label">Tasty Loss Index</div>
                <div class="tl-result-value" id="tl-value">0.000</div>
                <div class="tl-status" id="tl-status">Calculate to see status</div>
            </div>
            
            <!-- TL Status Legend -->
            <div class="tl-legend">
                <div class="tl-legend-title">Status Legend</div>
                <div class="tl-legend-item">
                    <div class="tl-legend-color low"></div>
                    <div class="tl-legend-text">< 0.3 - Food Fresh</div>
                </div>
                <div class="tl-legend-item">
                    <div class="tl-legend-color medium"></div>
                    <div class="tl-legend-text">0.3-0.7 - Monitor</div>
                </div>
                <div class="tl-legend-item">
                    <div class="tl-legend-color high"></div>
                    <div class="tl-legend-text">> 0.7 - Act Fast!</div>
                </div>
            </div>
            
            <div class="auto-update">Weather data auto-fills when available</div>
        </div>
        
        <!-- Weather Button -->
        <button id="weather-button" onclick="getWeatherForCurrentView()">
            üå§Ô∏è Get Weather
        </button>
        
        <!-- Weather Information Box -->
        <div id="weather-box">
            <button class="close-weather" onclick="closeWeatherBox()">&times;</button>
            <h3>Weather Information</h3>
            <div id="weather-content">
                <div class="weather-loading">Click the weather button to get weather data</div>
            </div>
        </div>
        <script src="js/qgis2web_expressions.js"></script>
        <script src="js/leaflet.js"></script>
        <script src="js/L.Control.Layers.Tree.min.js"></script>
        <script src="js/leaflet.rotatedMarker.js"></script>
        <script src="js/leaflet.pattern.js"></script>
        <script src="js/leaflet-hash.js"></script>
        <script src="js/Autolinker.min.js"></script>
        <script src="js/rbush.min.js"></script>
        <script src="js/labelgun.min.js"></script>
        <script src="js/labels.js"></script>
        <script src="js/leaflet.photon.js"></script>
        <script src="data/mcd_shapefilegeom_3857_1.js"></script>
        <script src="data/Buffered_2.js"></script>
        <script>
        var map = L.map('map', {
            zoomControl:false, maxZoom:28, minZoom:1
        }).fitBounds([[40.737807115632094,-73.99132236367937],[40.75080221606375,-73.96315052591935]]);
        var hash = new L.Hash(map);
        map.attributionControl.setPrefix('<a href="https://github.com/tomchadwin/qgis2web" target="_blank">qgis2web</a> &middot; <a href="https://leafletjs.com" title="A JS library for interactive maps">Leaflet</a> &middot; <a href="https://qgis.org">QGIS</a>');
        var autolinker = new Autolinker({truncate: {length: 30, location: 'smart'}});
        // remove popup's row if "visible-with-data"
        function removeEmptyRowsFromPopupContent(content, feature) {
         var tempDiv = document.createElement('div');
         tempDiv.innerHTML = content;
         var rows = tempDiv.querySelectorAll('tr');
         for (var i = 0; i < rows.length; i++) {
             var td = rows[i].querySelector('td.visible-with-data');
             var key = td ? td.id : '';
             if (td && td.classList.contains('visible-with-data') && feature.properties[key] == null) {
                 rows[i].parentNode.removeChild(rows[i]);
             }
         }
         return tempDiv.innerHTML;
        }
        // fetch real time weather data and add to popup - example code
        function fetchWeatherData(lat, lon, popup) {
            var apiKey = 'f370ae87a1504d5ab6f70708251709';
            var url = 'http://api.weatherapi.com/v1/current.json?key=' + apiKey + '&q=' + lat + ',' + lon + '&aqi=no';

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    var weatherContent = '<div class="weather-info">';
                    weatherContent += '<h4>Weather Information</h4>';
                    weatherContent += '<p>Location: ' + data.location.name + '</p>';
                    weatherContent += '<p>Temperature: ' + data.current.temp_c + ' ¬∞C</p>';
                    weatherContent += '<p>Condition: ' + data.current.condition.text + '</p>';
                    weatherContent += '</div>';

                    // Update popup content
                    popup.setContent(popup.getContent() + weatherContent);
                })
                .catch(error => console.error('Error fetching weather data:', error));
        }

        // Fetch weather data and display in dedicated weather box
        function fetchWeatherForBox(lat, lon) {
            var weatherBox = document.getElementById('weather-box');
            var weatherContent = document.getElementById('weather-content');
            
            // Show loading state
            weatherBox.style.display = 'block';
            weatherContent.innerHTML = '<div class="weather-loading">Loading weather data...</div>';
            
            var apiKey = 'f370ae87a1504d5ab6f70708251709';
            var url = 'https://api.weatherapi.com/v1/current.json?key=' + apiKey + '&q=' + lat + ',' + lon + '&aqi=no';

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    var content = '';
                    
                    // Weather icon
                    content += '<img src="https:' + data.current.condition.icon + '" alt="' + data.current.condition.text + '" class="weather-icon">';
                    
                    // Location
                    content += '<div class="weather-item">';
                    content += '<span class="weather-label">Location:</span>';
                    content += '<span class="weather-value">' + data.location.name + ', ' + data.location.region + '</span>';
                    content += '</div>';
                    
                    // Temperature
                    content += '<div class="weather-item">';
                    content += '<span class="weather-label">Temperature:</span>';
                    content += '<span class="weather-value">' + data.current.temp_c + '¬∞C (' + data.current.temp_f + '¬∞F)</span>';
                    content += '</div>';
                    
                    // Condition
                    content += '<div class="weather-item">';
                    content += '<span class="weather-label">Condition:</span>';
                    content += '<span class="weather-value">' + data.current.condition.text + '</span>';
                    content += '</div>';
                    
                    // Feels like
                    content += '<div class="weather-item">';
                    content += '<span class="weather-label">Feels like:</span>';
                    content += '<span class="weather-value">' + data.current.feelslike_c + '¬∞C</span>';
                    content += '</div>';
                    
                    // Humidity
                    content += '<div class="weather-item">';
                    content += '<span class="weather-label">Humidity:</span>';
                    content += '<span class="weather-value">' + data.current.humidity + '%</span>';
                    content += '</div>';
                    
                    // Wind
                    content += '<div class="weather-item">';
                    content += '<span class="weather-label">Wind:</span>';
                    content += '<span class="weather-value">' + data.current.wind_kph + ' km/h ' + data.current.wind_dir + '</span>';
                    content += '</div>';
                    
                    // UV Index
                    content += '<div class="weather-item">';
                    content += '<span class="weather-label">UV Index:</span>';
                    content += '<span class="weather-value">' + data.current.uv + '</span>';
                    content += '</div>';
                    
                    // Last updated
                    content += '<div class="weather-item">';
                    content += '<span class="weather-label">Last updated:</span>';
                    content += '<span class="weather-value">' + new Date(data.current.last_updated).toLocaleTimeString() + '</span>';
                    content += '</div>';
                    
                    weatherContent.innerHTML = content;
                    
                    // Update TL calculator with weather data
                    updateTLWithWeatherData(data);
                })
                .catch(error => {
                    console.error('Error fetching weather data:', error);
                    weatherContent.innerHTML = '<div class="weather-loading">Error loading weather data. Please try again.</div>';
                });
        }

        // Function to close weather box
        function closeWeatherBox() {
            document.getElementById('weather-box').style.display = 'none';
        }

        // Function to get weather data for current map view center
        function getWeatherForCurrentView() {
            var center = map.getCenter();
            var lat = center.lat;
            var lon = center.lng;
            fetchWeatherForBox(lat, lon);
        }

        // TL Index Calculator Functions
        function calculateTL() {
            // Get input values
            var H = parseFloat(document.getElementById('humidity-input').value) / 100; // Convert % to decimal
            var T = parseFloat(document.getElementById('temperature-input').value);
            var W = parseFloat(document.getElementById('wind-input').value); // Keep original wind speed
            var d = parseFloat(document.getElementById('distance-input').value); // Distance in meters
            
            // Validate inputs
            if (isNaN(H) || isNaN(T) || isNaN(W) || isNaN(d)) {
                document.getElementById('tl-value').textContent = 'Error';
                document.getElementById('tl-status').textContent = 'Invalid input values';
                return;
            }
            
            // Calculate TL using the formula: TL(d) = 1 - exp(-(H‚ãÖT)‚ãÖ(1+W)‚ãÖd/1.4)
            // Adjust the formula to prevent extremely large negative exponents
            var scalingFactor = 0.001; // Add scaling factor to make the calculation more reasonable
            var exponent = -(H * T) * (1 + W * 0.1) * (d / 1.4) * scalingFactor;
            var TL = 1 - 40 * Math.exp(exponent); // 40 is the variation factor for chips structure and packaging, 40 is a default value value
            
            // Ensure TL is between 0 and 1
            TL = Math.max(0, Math.min(1, TL));
            
            // Update display
            document.getElementById('tl-value').textContent = TL.toFixed(3);
            
            // Update status based on TL value
            var statusElement = document.getElementById('tl-status');
            statusElement.className = 'tl-status';
            
            var tlStatusType;
            if (TL < 0.3) {
                statusElement.classList.add('low');
                statusElement.textContent = 'Low Loss - Food Fresh';
                tlStatusType = 'low';
            } else if (TL < 0.7) {
                statusElement.classList.add('medium');
                statusElement.textContent = 'Medium Loss - Monitor';
                tlStatusType = 'medium';
            } else {
                statusElement.classList.add('high');
                statusElement.textContent = 'High Loss - Act Fast!';
                tlStatusType = 'high';
            }
            
            // Update buffer color based on TL status
            updateBufferColor(tlStatusType);
            
            // Debug output to console
            console.log('TL Calculation Debug:');
            console.log('H:', H, 'T:', T, 'W:', W, 'd:', d);
            console.log('Exponent:', exponent);
            console.log('TL Result:', TL);
            console.log('TL Status:', tlStatusType);
        }
        
        // Function to update TL calculator with weather data
        function updateTLWithWeatherData(weatherData) {
            // Update input fields with weather data
            document.getElementById('humidity-input').value = weatherData.current.humidity;
            document.getElementById('temperature-input').value = weatherData.current.temp_c;
            document.getElementById('wind-input').value = weatherData.current.wind_kph;
            
            // Don't auto-calculate TL index anymore - user must click button
        }
        
        // Initialize calculator without real-time calculation
        document.addEventListener('DOMContentLoaded', function() {
            // Set initial result display
            document.getElementById('tl-value').textContent = '---';
            document.getElementById('tl-status').textContent = 'Click Calculate to see result';
        });

        // add class to format popup if it contains media
		function addClassToPopupIfMedia(content, popup) {
			var tempDiv = document.createElement('div');
			tempDiv.innerHTML = content;
			if (tempDiv.querySelector('td img')) {
				popup._contentNode.classList.add('media');
					// Delay to force the redraw
					setTimeout(function() {
						popup.update();
					}, 10);
			} else {
				popup._contentNode.classList.remove('media');
			}
		}
        var zoomControl = L.control.zoom({
            position: 'topleft'
        }).addTo(map);
        
        // Add scale bar control
        var scaleControl = L.control.scale({
            position: 'bottomleft',
            metric: true,
            imperial: true,
            maxWidth: 200
        }).addTo(map);
        
        var bounds_group = new L.featureGroup([]);
        function setBounds() {
        }
        map.createPane('pane_OSMStandard_0');
        map.getPane('pane_OSMStandard_0').style.zIndex = 400;
        var layer_OSMStandard_0 = L.tileLayer('http://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            pane: 'pane_OSMStandard_0',
            opacity: 1.0,
            attribution: '<a href="https://www.openstreetmap.org/copyright">¬© OpenStreetMap contributors, CC-BY-SA</a>',
            minZoom: 1,
            maxZoom: 28,
            minNativeZoom: 0,
            maxNativeZoom: 19
        });
        layer_OSMStandard_0;
        map.addLayer(layer_OSMStandard_0);
        function pop_mcd_shapefilegeom_3857_1(feature, layer) {
            var popupContent = '<table>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['gid'] !== null ? autolinker.link(String(feature.properties['gid']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['storenumbe'] !== null ? autolinker.link(String(feature.properties['storenumbe']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['storetype'] !== null ? autolinker.link(String(feature.properties['storetype']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['address'] !== null ? autolinker.link(String(feature.properties['address']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['city'] !== null ? autolinker.link(String(feature.properties['city']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['state'] !== null ? autolinker.link(String(feature.properties['state']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['zip'] !== null ? autolinker.link(String(feature.properties['zip']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['phone'] !== null ? autolinker.link(String(feature.properties['phone']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['playplace'] !== null ? autolinker.link(String(feature.properties['playplace']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['drivethru'] !== null ? autolinker.link(String(feature.properties['drivethru']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['archcard'] !== null ? autolinker.link(String(feature.properties['archcard']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['freewifi'] !== null ? autolinker.link(String(feature.properties['freewifi']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['storeurl'] !== null ? autolinker.link(String(feature.properties['storeurl']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['geom'] !== null ? autolinker.link(String(feature.properties['geom']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                </table>';
            var content = removeEmptyRowsFromPopupContent(popupContent, feature);
			layer.on('popupopen', function(e) {
				addClassToPopupIfMedia(content, e.popup);
			});
			layer.bindPopup(content, { maxHeight: 400 });
        }

        function style_mcd_shapefilegeom_3857_1_0() {
            return {
                pane: 'pane_mcd_shapefilegeom_3857_1',
                radius: 4.0,
                opacity: 1,
                color: 'rgba(35,35,35,1.0)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 1,
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(243,166,178,1.0)',
                interactive: true,
            }
        }
        map.createPane('pane_mcd_shapefilegeom_3857_1');
        map.getPane('pane_mcd_shapefilegeom_3857_1').style.zIndex = 403;
        map.getPane('pane_mcd_shapefilegeom_3857_1').style['mix-blend-mode'] = 'normal';
        var layer_mcd_shapefilegeom_3857_1 = new L.geoJson(json_mcd_shapefilegeom_3857_1, {
            attribution: '',
            interactive: true,
            dataVar: 'json_mcd_shapefilegeom_3857_1',
            layerName: 'layer_mcd_shapefilegeom_3857_1',
            pane: 'pane_mcd_shapefilegeom_3857_1',
            onEachFeature: pop_mcd_shapefilegeom_3857_1,
            pointToLayer: function (feature, latlng) {
                var context = {
                    feature: feature,
                    variables: {}
                };
                return L.circleMarker(latlng, style_mcd_shapefilegeom_3857_1_0(feature));
            },
        });
        bounds_group.addLayer(layer_mcd_shapefilegeom_3857_1);
        map.addLayer(layer_mcd_shapefilegeom_3857_1);
        function pop_Buffered_2(feature, layer) {
            var popupContent = '<table>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['gid'] !== null ? autolinker.link(String(feature.properties['gid']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['storenumbe'] !== null ? autolinker.link(String(feature.properties['storenumbe']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['storetype'] !== null ? autolinker.link(String(feature.properties['storetype']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['address'] !== null ? autolinker.link(String(feature.properties['address']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['city'] !== null ? autolinker.link(String(feature.properties['city']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['state'] !== null ? autolinker.link(String(feature.properties['state']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['zip'] !== null ? autolinker.link(String(feature.properties['zip']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['phone'] !== null ? autolinker.link(String(feature.properties['phone']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['playplace'] !== null ? autolinker.link(String(feature.properties['playplace']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['drivethru'] !== null ? autolinker.link(String(feature.properties['drivethru']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['archcard'] !== null ? autolinker.link(String(feature.properties['archcard']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['freewifi'] !== null ? autolinker.link(String(feature.properties['freewifi']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['storeurl'] !== null ? autolinker.link(String(feature.properties['storeurl']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['geom'] !== null ? autolinker.link(String(feature.properties['geom']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                </table>';
            var content = removeEmptyRowsFromPopupContent(popupContent, feature);
			layer.on('popupopen', function(e) {
				addClassToPopupIfMedia(content, e.popup);
			});
			layer.bindPopup(content, { maxHeight: 400 });
        }

        // Global variable to store current TL status
        var currentTLStatus = 'default';
        // Global variable for dynamic buffer radius (in meters)
        var bufferRadius = 500; // Default 500 meters
        // Global variable for dynamic buffer layer
        var dynamicBufferLayer = null;
        
        function style_Buffered_2_0() {
            var fillColor;
            var fillOpacity = 0.6; // Make it more transparent to see underlying map
            
            // Set color based on current TL status
            switch(currentTLStatus) {
                case 'low':
                    fillColor = 'rgba(212, 237, 218, 0.8)'; // Green - Food Fresh
                    break;
                case 'medium':
                    fillColor = 'rgba(255, 243, 205, 0.8)'; // Yellow - Monitor
                    break;
                case 'high':
                    fillColor = 'rgba(248, 215, 218, 0.8)'; // Red - Act Fast
                    break;
                default:
                    fillColor = 'rgba(229,182,54,0.6)'; // Original orange/yellow
                    break;
            }
            
            return {
                pane: 'pane_Buffered_2',
                opacity: 1,
                color: 'rgba(35,35,35,1.0)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 1.0, 
                fill: true,
                fillOpacity: fillOpacity,
                fillColor: fillColor,
                interactive: true,
            }
        }
        
        // Function to create dynamic buffer circles around store locations
        function createDynamicBuffers(radius) {
            // Remove existing dynamic buffer layer if it exists
            if (dynamicBufferLayer) {
                map.removeLayer(dynamicBufferLayer);
            }
            
            // Create new layer group for dynamic buffers
            dynamicBufferLayer = L.layerGroup();
            
            // Get store locations from the existing layer
            if (layer_mcd_shapefilegeom_3857_1) {
                layer_mcd_shapefilegeom_3857_1.eachLayer(function(layer) {
                    var latlng = layer.getLatLng();
                    
                    // Create circle with dynamic radius
                    var circle = L.circle(latlng, {
                        radius: radius, // radius in meters
                        ...style_Buffered_2_0() // Use the same styling function
                    });
                    
                    // Add popup functionality with store address only
                    var feature = layer.feature;
                    if (feature && feature.properties) {
                        var address = feature.properties['address'] || 'Address not available';
                        var city = feature.properties['city'] || '';
                        var state = feature.properties['state'] || '';
                        var zip = feature.properties['zip'] || '';
                        
                        // Create a clean, formatted popup
                        var popupContent = '<div style="padding: 10px; font-family: Arial, sans-serif;">';
                        popupContent += '<div style="color: #e74c3c; font-weight: bold; font-size: 14px; margin-bottom: 8px;">üçü McDonald\'s Store</div>';
                        popupContent += '<div style="color: #333; font-size: 13px; line-height: 1.4;">';
                        popupContent += '<strong>üìç Address:</strong><br>';
                        popupContent += address;
                        if (city || state || zip) {
                            popupContent += '<br>' + city;
                            if (city && (state || zip)) popupContent += ', ';
                            if (state) popupContent += state;
                            if (state && zip) popupContent += ' ';
                            if (zip) popupContent += zip;
                        }
                        popupContent += '</div>';
                        popupContent += '</div>';
                        
                        circle.bindPopup(popupContent, { 
                            maxHeight: 200,
                            className: 'custom-popup'
                        });
                    }
                    
                    dynamicBufferLayer.addLayer(circle);
                });
                
                // Add the dynamic buffer layer to the map
                map.addLayer(dynamicBufferLayer);
            }
        }
        
        // Function to update buffer color and radius
        function updateBufferColor(tlStatus) {
            currentTLStatus = tlStatus;
            
            // Get current distance from input
            var distanceInput = document.getElementById('distance-input');
            if (distanceInput) {
                bufferRadius = parseFloat(distanceInput.value) || 500;
            }
            
            // Recreate dynamic buffers with new radius and color
            createDynamicBuffers(bufferRadius);
            
            // Also update original static buffer if it exists and is visible
            if (layer_Buffered_2 && map.hasLayer(layer_Buffered_2)) {
                layer_Buffered_2.setStyle(style_Buffered_2_0());
            }
        }
        map.createPane('pane_Buffered_2');
        map.getPane('pane_Buffered_2').style.zIndex = 402;
        map.getPane('pane_Buffered_2').style['mix-blend-mode'] = 'normal';
        var layer_Buffered_2 = new L.geoJson(json_Buffered_2, {
            attribution: '',
            interactive: true,
            dataVar: 'json_Buffered_2',
            layerName: 'layer_Buffered_2',
            pane: 'pane_Buffered_2',
            onEachFeature: pop_Buffered_2,
            style: style_Buffered_2_0,
        });
        bounds_group.addLayer(layer_Buffered_2);
        map.addLayer(layer_Buffered_2);
        
        // Control buffer visibility based on zoom level
        function controlBufferVisibility() {
            var currentZoom = map.getZoom();
            var minZoomForBuffer = 13; // Adjust this value as needed
            
            if (currentZoom >= minZoomForBuffer) {
                // Show dynamic buffer if it exists, otherwise show static buffer
                if (dynamicBufferLayer && !map.hasLayer(dynamicBufferLayer)) {
                    map.addLayer(dynamicBufferLayer);
                } else if (!dynamicBufferLayer && !map.hasLayer(layer_Buffered_2)) {
                    map.addLayer(layer_Buffered_2);
                }
            } else {
                // Hide both dynamic and static buffers
                if (dynamicBufferLayer && map.hasLayer(dynamicBufferLayer)) {
                    map.removeLayer(dynamicBufferLayer);
                }
                if (map.hasLayer(layer_Buffered_2)) {
                    map.removeLayer(layer_Buffered_2);
                }
            }
        }
        
        // Add zoom event listener to control buffer visibility
        map.on('zoomend', controlBufferVisibility);
        
        // Set initial visibility based on current zoom
        controlBufferVisibility();
        var overlaysTree = [
            {label: '<img src="legend/Buffered_2.png" /> Buffered', layer: layer_Buffered_2},
            {label: '<img src="legend/mcd_shapefilegeom_3857_1.png" /> Store', layer: layer_mcd_shapefilegeom_3857_1},
            {label: "OSM Standard", layer: layer_OSMStandard_0, radioGroup: 'bm' },]
        var lay = L.control.layers.tree(null, overlaysTree,{
            //namedToggle: true,
            //selectorBack: false,
            //closedSymbol: '&#8862; &#x1f5c0;',
            //openedSymbol: '&#8863; &#x1f5c1;',
            //collapseAll: 'Collapse all',
            //expandAll: 'Expand all',
            collapsed: false, 
        });
        lay.addTo(map);
		document.addEventListener("DOMContentLoaded", function() {
            // set new Layers List height which considers toggle icon
            function newLayersListHeight() {
                var layerScrollbarElement = document.querySelector('.leaflet-control-layers-scrollbar');
                if (layerScrollbarElement) {
                    var layersListElement = document.querySelector('.leaflet-control-layers-list');
                    var originalHeight = layersListElement.style.height 
                        || window.getComputedStyle(layersListElement).height;
                    var newHeight = parseFloat(originalHeight) - 50;
                    layersListElement.style.height = newHeight + 'px';
                }
            }
            var isLayersListExpanded = true;
            var controlLayersElement = document.querySelector('.leaflet-control-layers');
            var toggleLayerControl = document.querySelector('.leaflet-control-layers-toggle');
            // toggle Collapsed/Expanded and apply new Layers List height
            toggleLayerControl.addEventListener('click', function() {
                if (isLayersListExpanded) {
                    controlLayersElement.classList.remove('leaflet-control-layers-expanded');
                } else {
                    controlLayersElement.classList.add('leaflet-control-layers-expanded');
                }
                isLayersListExpanded = !isLayersListExpanded;
                newLayersListHeight()
            });	
			// apply new Layers List height if toggle layerstree
			if (controlLayersElement) {
				controlLayersElement.addEventListener('click', function(event) {
					var toggleLayerHeaderPointer = event.target.closest('.leaflet-layerstree-header-pointer span');
					if (toggleLayerHeaderPointer) {
						newLayersListHeight();
					}
				});
			}
            // Collapsed/Expanded at Start to apply new height
            setTimeout(function() {
                toggleLayerControl.click();
            }, 10);
            setTimeout(function() {
                toggleLayerControl.click();
            }, 10);
            // Collapsed touch/small screen
            var isSmallScreen = window.innerWidth < 650;
            if (isSmallScreen) {
                setTimeout(function() {
                    controlLayersElement.classList.remove('leaflet-control-layers-expanded');
                    isLayersListExpanded = !isLayersListExpanded;
                }, 500);
            }  
        });       
        setBounds();
        
        // Initialize dynamic buffers with default radius
        setTimeout(function() {
            createDynamicBuffers(500); // Default 500 meter radius
            // Hide static buffer since we're using dynamic ones
            if (map.hasLayer(layer_Buffered_2)) {
                map.removeLayer(layer_Buffered_2);
            }
        }, 100);
        </script>
    </body>
</html>
